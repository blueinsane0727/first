#include <REGX52.H>
#include "Timer0.h"
#include "Delay.h"

//本代码主要借鉴和学习了江科大51单片机教程，并且作者嫌麻烦没有把音符顺序定义放在代码里，需要改动旋律可能会比较麻烦

sbit Buzzer=P2^5;

//定义音符频率
unsigned int Freqtable[]={0,63628,63731,63835,63928,64021,64103,64185,64260,64331,
64400,64463,64528,64580,64633,64684,64732,64777,64820,64860,64898,64934,64968,
65000,65030,65058,65085,65110,65134,65157,65178,65198,65217,65235,65252,65268,
65283};

unsigned char FreqSelect,MusicSelect1,MusicSelect2,MusicSelect3;

//因为歌曲太长导致写进一个数组无法全部播放，所以这里分成了三个数组
unsigned char code Music1[]={
//1
30,4,
28,2,
26,4,
28,2,
//2
30,3,
31,1,
30,2,
28,5,
//3
30,4,
28,2,
26,4,
28,2,
//4
30,3,
31,1,
30,2,
28,5,
//5
30,4,
28,2,
26,4,
28,2,
//6
30,3,
31,1,
30,2,
28,5,
//7
30,4,
28,2,
26,4,
28,2,
//8
30,3,
31,1,
30,2,
28,5,
14,1,
16,1,
//9
18,2,
18,2,
16,2,
19,2,
18,2,
16,2,
//10
16,2,
16,2,
14,1,
14,1,
19,2,
18,2,
16,2,
//11
16,4,
14,1,
16,1,
18,5,
//12
0,5,
18,2,
21,2,
26,2,
//13
25,4,
26,2,
25,4,
26,2,
//14
25,1,
23,1,
21,4,
21,2,
16,2,
19,2,
//15
19,4,
18,2,
18,4,
9,2,
//16
19,2,
18,2,
16,2,
18,4,
21,2,
//17
14,5,
0,4,
14,2,
//18
16,2,
14,3,
14,1,
14,2,
21,2,
14,2,
//19
19,4,
18,2,
16,4,
14,2,
0xFF};

unsigned char code Music2[]={
//20
14,5,
0,4,
14,1,
16,1,
//21
18,2,
18,2,
16,2,
19,2,
18,2,
16,2,
//22
16,2,
16,2,
14,2,
19,2,
18,2,
16,2,
//23
16,4,
14,1,
16,1,
18,5,
//24
0,5,
18,2,
21,2,
26,2,
//25
25,4,
26,2,
25,4,
26,2,
//26
25,1,
23,1,
21,4,
21,2,
16,2,
19,2,
//27
19,4,
18,2,
18,4,
9,2,
//28
19,2,
18,2,
16,2,
18,4,
21,2,
//29
14,5,
0,4,
14,1,
14,1,
//30
16,2,
14,4,
14,2,
21,2,
14,2,
//31
19,2,
19,1,
19,1,
18,1,
16,1,
16,4,
14,2,
//32
14,3,
0,3,
0,5,
//33
35,2,
33,2,
33,2,
33,2,
31,2,
31,2,
//34
30,2,
28,2,
28,2,
28,2,
0,2,
21,2,
//35
21,2,
19,1,
19,1,
19,2,
19,2,
18,2,
16,2,
//36
16,4,
14,1,
13,1,
14,3,
0,3,
//37
35,2,
33,2,
33,2,
33,2,
31,2,
31,2,
//38
30,2,
28,2,
28,2,
28,2,
0,2,
18,2,
//39
18,2,
18,1,
18,1,
18,1,
18,1,
18,2,
16,2,
18,2,
0xFF};

unsigned char code Music3[]={
//40
28,4,
26,2,
26,2,
0,2,
26,2,
//41
25,4,
23,2,
23,5,
//42
0,4,
23,2,
23,2,
21,2,
19,1,
19,1,
//43
19,5,
18,1,
19,1,
21,9,
0,5,
//44
18,1,
16,1,
18,1,
16,1,
18,1,
19,1,
21,2,
0,2,
19,1,
21,1,
//45
23,2,
0,2,
23,1,
25,1,
26,2,
0,2,
28,1,
16,1,
//46
21,4,
0,1,
14,1,
21,2,
19,2,
19,2,
//47
18,4,
18,1,
19,1,
21,4,
0,2,
//48
18,1,
16,1,
18,1,
16,1,
18,1,
19,1,
21,2,
0,2,
19,1,
21,1,
//49
23,2,
0,2,
22,1,
23,1,
25,2,
0,3,
18,1,
//50
30,2,
30,2,
0,1,
18,1,
31,2,
30,2,
28,2,
//51
28,4,
26,1,
25,1,
26,2,
0,2,
21,1,
26,1,
//52
28,4,
26,2,
26,2,
0,2,
21,2,
//53
28,4,
26,2,
26,2,
0,2,
21,1,
26,1,
//54
28,4,
26,2,
26,2,
0,2,
21,1,
26,1,
//55
28,3,
30,1,
28,2,
26,2,
0,2,
16,2,
//56
25,4,
23,2,
23,2,
0,2,
21,2,
//57
21,4,
19,2,
19,2,
18,2,
16,2,
//58
18,5,
0,5,
//59
18,2,
19,2,
18,2,
19,2,
18,2,
16,2,
//60
14,10,
	0xFF
};

void main()
{
	Timer0Init();
	while(1)
    {
        if(Music1[MusicSelect1]!=0xFF)
        {
            FreqSelect=Music1[MusicSelect1];
            MusicSelect1++;
            Delay(135*Music1[MusicSelect1]);	//这里速度按谱子应该是155，但是我感觉有点慢于是定了135可能还需要改
            MusicSelect1++;
            TR0=0;
            Delay(5);
            TR0=1;
        }
        else
        {
					
            if(Music2[MusicSelect2]!=0xFF)
            {
                FreqSelect=Music2[MusicSelect2];
                MusicSelect2++;
                Delay(135*Music2[MusicSelect2]);
                MusicSelect2++;
                TR0=0;
                Delay(5);
                TR0=1;
            }
            else
            {
							
                if(Music3[MusicSelect3]!=0xFF)
                {
                    FreqSelect=Music3[MusicSelect3];
                    MusicSelect3++;
                    Delay(135*Music3[MusicSelect3]);
                    MusicSelect3++;
                    TR0=0;
                    Delay(5);
                    TR0=1;
                }
                else
                {
                    TR0=0;
                    while(1);
                }
            }
        }
    }
}

void Timer0_Routine()	interrupt 1
{
	if(Freqtable[FreqSelect])
	{
		TL0=Freqtable[FreqSelect]%256;	//设置定时初值
		TH0=Freqtable[FreqSelect]/256;	//设置定时初值
		Buzzer=!Buzzer;
	}
	
}

